#nullable enable
using Neatoo.RemoteFactory;
using Neatoo.RemoteFactory.Internal;
using Microsoft.Extensions.DependencyInjection;

/*
							READONLY - DO NOT EDIT!!!!
							Generated by Neatoo.RemoteFactory
*/
namespace Neatoo.RemoteFactory.AspNetCore.TestLibrary
{
    public interface IHttpAuthorizedRecordFactory
    {
        HttpAuthorizedRecord Create(string Name);
        Task<HttpAuthorizedRecord?> FetchAuthorized(string name);
        Task<HttpAuthorizedRecord?> FetchUnauthorized(string name);
        Task<Authorized> CanFetchAuthorized();
        Task<Authorized> CanFetchUnauthorized();
    }

    internal class HttpAuthorizedRecordFactory : FactoryBase<HttpAuthorizedRecord>, IHttpAuthorizedRecordFactory
    {
        private readonly IServiceProvider ServiceProvider;
        private readonly IMakeRemoteDelegateRequest? MakeRemoteDelegateRequest;
        // Delegates
        public delegate Task<Authorized<HttpAuthorizedRecord>> FetchAuthorizedDelegate(string name);
        public delegate Task<Authorized<HttpAuthorizedRecord>> FetchUnauthorizedDelegate(string name);
        public delegate Task<Authorized> CanFetchAuthorizedDelegate();
        public delegate Task<Authorized> CanFetchUnauthorizedDelegate();
        // Delegate Properties to provide Local or Remote fork in execution
        public FetchAuthorizedDelegate FetchAuthorizedProperty { get; }
        public FetchUnauthorizedDelegate FetchUnauthorizedProperty { get; }
        public CanFetchAuthorizedDelegate CanFetchAuthorizedProperty { get; }
        public CanFetchUnauthorizedDelegate CanFetchUnauthorizedProperty { get; }

        public HttpAuthorizedRecordFactory(IServiceProvider serviceProvider, IFactoryCore<HttpAuthorizedRecord> factoryCore) : base(factoryCore)
        {
            this.ServiceProvider = serviceProvider;
            FetchAuthorizedProperty = LocalFetchAuthorized;
            FetchUnauthorizedProperty = LocalFetchUnauthorized;
            CanFetchAuthorizedProperty = LocalCanFetchAuthorized;
            CanFetchUnauthorizedProperty = LocalCanFetchUnauthorized;
        }

        public HttpAuthorizedRecordFactory(IServiceProvider serviceProvider, IMakeRemoteDelegateRequest remoteMethodDelegate, IFactoryCore<HttpAuthorizedRecord> factoryCore) : base(factoryCore)
        {
            this.ServiceProvider = serviceProvider;
            this.MakeRemoteDelegateRequest = remoteMethodDelegate;
            FetchAuthorizedProperty = RemoteFetchAuthorized;
            FetchUnauthorizedProperty = RemoteFetchUnauthorized;
            CanFetchAuthorizedProperty = RemoteCanFetchAuthorized;
            CanFetchUnauthorizedProperty = RemoteCanFetchUnauthorized;
        }

        public virtual HttpAuthorizedRecord Create(string Name)
        {
            return LocalCreate(Name);
        }

        public HttpAuthorizedRecord LocalCreate(string Name)
        {
            return DoFactoryMethodCall(FactoryOperation.Create, () => new HttpAuthorizedRecord(Name));
        }

        public virtual async Task<HttpAuthorizedRecord?> FetchAuthorized(string name)
        {
            return (await FetchAuthorizedProperty(name)).Result;
        }

        public virtual async Task<Authorized<HttpAuthorizedRecord>> RemoteFetchAuthorized(string name)
        {
            return (await MakeRemoteDelegateRequest!.ForDelegate<Authorized<HttpAuthorizedRecord>>(typeof(FetchAuthorizedDelegate), [name], default))!;
        }

        public async Task<Authorized<HttpAuthorizedRecord>> LocalFetchAuthorized(string name)
        {
            Authorized authorized;
            var aspAuthorized = ServiceProvider.GetRequiredService<IAspAuthorize>();
            authorized = await aspAuthorized.Authorize([new AspAuthorizeData("TestPolicy") { Roles = "Test role" }], false);
            if (!authorized.HasAccess)
            {
                return new Authorized<HttpAuthorizedRecord>(authorized);
            }

            return new Authorized<HttpAuthorizedRecord>(DoFactoryMethodCall(FactoryOperation.Fetch, () => HttpAuthorizedRecord.FetchAuthorized(name)));
        }

        public virtual async Task<HttpAuthorizedRecord?> FetchUnauthorized(string name)
        {
            return (await FetchUnauthorizedProperty(name)).Result;
        }

        public virtual async Task<Authorized<HttpAuthorizedRecord>> RemoteFetchUnauthorized(string name)
        {
            return (await MakeRemoteDelegateRequest!.ForDelegate<Authorized<HttpAuthorizedRecord>>(typeof(FetchUnauthorizedDelegate), [name], default))!;
        }

        public async Task<Authorized<HttpAuthorizedRecord>> LocalFetchUnauthorized(string name)
        {
            Authorized authorized;
            var aspAuthorized = ServiceProvider.GetRequiredService<IAspAuthorize>();
            authorized = await aspAuthorized.Authorize([new AspAuthorizeData() { Roles = "No auth" }], false);
            if (!authorized.HasAccess)
            {
                return new Authorized<HttpAuthorizedRecord>(authorized);
            }

            return new Authorized<HttpAuthorizedRecord>(DoFactoryMethodCall(FactoryOperation.Fetch, () => HttpAuthorizedRecord.FetchUnauthorized(name)));
        }

        public virtual Task<Authorized> CanFetchAuthorized()
        {
            return CanFetchAuthorizedProperty();
        }

        public virtual async Task<Authorized> RemoteCanFetchAuthorized()
        {
            return (await MakeRemoteDelegateRequest!.ForDelegate<Authorized>(typeof(CanFetchAuthorizedDelegate), [], default))!;
        }

        public async Task<Authorized> LocalCanFetchAuthorized()
        {
            Authorized authorized;
            var aspAuthorized = ServiceProvider.GetRequiredService<IAspAuthorize>();
            authorized = await aspAuthorized.Authorize([new AspAuthorizeData("TestPolicy") { Roles = "Test role" }], false);
            if (!authorized.HasAccess)
            {
                return new Authorized(authorized);
            }

            return new Authorized(true);
        }

        public virtual Task<Authorized> CanFetchUnauthorized()
        {
            return CanFetchUnauthorizedProperty();
        }

        public virtual async Task<Authorized> RemoteCanFetchUnauthorized()
        {
            return (await MakeRemoteDelegateRequest!.ForDelegate<Authorized>(typeof(CanFetchUnauthorizedDelegate), [], default))!;
        }

        public async Task<Authorized> LocalCanFetchUnauthorized()
        {
            Authorized authorized;
            var aspAuthorized = ServiceProvider.GetRequiredService<IAspAuthorize>();
            authorized = await aspAuthorized.Authorize([new AspAuthorizeData() { Roles = "No auth" }], false);
            if (!authorized.HasAccess)
            {
                return new Authorized(authorized);
            }

            return new Authorized(true);
        }

        public static void FactoryServiceRegistrar(IServiceCollection services, NeatooFactory remoteLocal)
        {
            services.AddScoped<HttpAuthorizedRecordFactory>();
            services.AddScoped<IHttpAuthorizedRecordFactory, HttpAuthorizedRecordFactory>();
            services.AddScoped<FetchAuthorizedDelegate>(cc =>
            {
                var factory = cc.GetRequiredService<HttpAuthorizedRecordFactory>();
                return (string name) => factory.LocalFetchAuthorized(name);
            });
            services.AddScoped<FetchUnauthorizedDelegate>(cc =>
            {
                var factory = cc.GetRequiredService<HttpAuthorizedRecordFactory>();
                return (string name) => factory.LocalFetchUnauthorized(name);
            });
            services.AddScoped<CanFetchAuthorizedDelegate>(cc =>
            {
                var factory = cc.GetRequiredService<HttpAuthorizedRecordFactory>();
                return () => factory.LocalCanFetchAuthorized();
            });
            services.AddScoped<CanFetchUnauthorizedDelegate>(cc =>
            {
                var factory = cc.GetRequiredService<HttpAuthorizedRecordFactory>();
                return () => factory.LocalCanFetchUnauthorized();
            });
            // Register AOT-compatible ordinal converter
            global::Neatoo.RemoteFactory.Internal.NeatooOrdinalConverterFactory.RegisterConverter(HttpAuthorizedRecord.CreateOrdinalConverter());
        }
    }
}