@page "/"

@using Person.DomainModel
@inject IPersonModelFactory PersonModelFactory
@inject IUser User
@inject ISnackbar Snackbar

<MudText Typo="Typo.h4" Class="mb-4">User Role</MudText>

<MudPaper Elevation="2" Class="pa-4 mb-6">
    <MudRadioGroup T="Role" @bind-Value="selectedRole">
        <MudRadio T="Role" Value="Role.None" Color="Color.Default">None</MudRadio>
        <MudRadio T="Role" Value="Role.Create" Color="Color.Primary">Create</MudRadio>
        <MudRadio T="Role" Value="Role.Fetch" Color="Color.Primary">Fetch</MudRadio>
        <MudRadio T="Role" Value="Role.Update" Color="Color.Primary">Update</MudRadio>
        <MudRadio T="Role" Value="Role.Delete" Color="Color.Primary">Delete</MudRadio>
    </MudRadioGroup>
</MudPaper>

<MudText Typo="Typo.h4" Class="mb-4">Person</MudText>

@if (PersonModel == null)
{
    <MudAlert Severity="Severity.Info" Class="mb-4">
        Not loaded - Select a role and use the buttons below to create or fetch a person.
    </MudAlert>
}
else
{
    <MudPaper Elevation="2" Class="pa-4 mb-4">
        <EditForm Model="PersonModel" OnValidSubmit="HandleValidSubmit">
            <DataAnnotationsValidator />

            <MudGrid>
                <MudItem xs="12" sm="6">
                    <MudTextField T="string"
                                  Label="First Name"
                                  @bind-Value="PersonModel.FirstName"
                                  For="@(() => PersonModel.FirstName)"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Required="true"
                                  RequiredError="First Name is required" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudTextField T="string"
                                  Label="Last Name"
                                  @bind-Value="PersonModel.LastName"
                                  For="@(() => PersonModel.LastName)"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Required="true"
                                  RequiredError="Last Name is required" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudTextField T="string"
                                  Label="Email"
                                  @bind-Value="PersonModel.Email"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  InputType="InputType.Email"
                                  HelperText="Enter a valid email address" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudTextField T="string"
                                  Label="Phone"
                                  @bind-Value="PersonModel.Phone"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  HelperText="Enter phone number" />
                </MudItem>

                <MudItem xs="12">
                    <MudTextField T="string"
                                  Label="Notes"
                                  @bind-Value="PersonModel.Notes"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Lines="3" />
                </MudItem>

                <MudItem xs="12">
                    <MudButton ButtonType="ButtonType.Submit"
                               Variant="Variant.Filled"
                               Color="Color.Primary"
                               Disabled="@(!CanUpdate)"
                               StartIcon="@Icons.Material.Filled.Save"
                               Class="mr-2">
                        Update
                    </MudButton>
                </MudItem>
            </MudGrid>
        </EditForm>
    </MudPaper>
}

<MudPaper Elevation="0" Class="d-flex gap-2">
    <MudButton Variant="Variant.Filled"
               Color="Color.Primary"
               OnClick="Create"
               Disabled="@(!CanCreate)"
               StartIcon="@Icons.Material.Filled.Add">
        Create
    </MudButton>
    <MudButton Variant="Variant.Filled"
               Color="Color.Secondary"
               OnClick="Fetch"
               Disabled="@(!CanFetch)"
               StartIcon="@Icons.Material.Filled.Download">
        Fetch
    </MudButton>
    <MudButton Variant="Variant.Filled"
               Color="Color.Error"
               OnClick="Delete"
               Disabled="@(!CanDelete)"
               StartIcon="@Icons.Material.Filled.Delete">
        Delete
    </MudButton>
</MudPaper>

@code {

    public IPersonModel? PersonModel { get; set; } = default!;

    private bool CanCreate { get; set; }
    private bool CanFetch { get; set; }
    private bool CanUpdate { get; set; }
    private bool CanDelete { get; set; }

    public Role selectedRole
    {
        get;
        set
        {
            field = value;
            UserRoleChanged();
        }
    } = default!;

    [Inject(Key = Neatoo.RemoteFactory.RemoteFactoryServices.HttpClientKey)]
    private HttpClient httpClient { get; set; } = default!;

    protected override void OnInitialized()
    {
        base.OnInitialized();
    }

    private async Task HandleValidSubmit()
    {
        try
        {
            PersonModel = await PersonModelFactory.Save(PersonModel!);
            Snackbar.Add("Person saved successfully!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving person: {ex.Message}", Severity.Error);
        }
    }

    private async Task Fetch()
    {
        try
        {
            PersonModel = await PersonModelFactory.Fetch();
            Snackbar.Add("Person fetched successfully!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error fetching person: {ex.Message}", Severity.Error);
        }
    }

    private void Create()
    {
        try
        {
            PersonModel = PersonModelFactory.Create();
            Snackbar.Add("New person created!", Severity.Info);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error creating person: {ex.Message}", Severity.Error);
        }
    }

    private async Task Delete()
    {
        try
        {
            this.PersonModel!.IsDeleted = true;
            await PersonModelFactory.Save(PersonModel!);
            this.PersonModel = null;
            Snackbar.Add("Person deleted successfully!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error deleting person: {ex.Message}", Severity.Error);
        }
    }

    private void UserRoleChanged()
    {
        try
        {
            httpClient.DefaultRequestHeaders.Remove("UserRoles");
            httpClient.DefaultRequestHeaders.Add("UserRoles", selectedRole.ToString());
            if (selectedRole == Role.None)
            {
                PersonModel = null;
            }

            User.Role = selectedRole;
            CanCreate = PersonModelFactory.CanCreate();
            CanFetch = PersonModelFactory.CanFetch();
            CanUpdate = PersonModelFactory.CanUpsert();
            CanDelete = PersonModelFactory.CanDelete();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            Snackbar.Add($"Error changing role: {ex.Message}", Severity.Error);
        }
    }

}
