# NF0404: Event method must have CancellationToken as final parameter

## Description

Event methods marked with `[Event]` must have `CancellationToken` as their final parameter. This token receives the `ApplicationStopping` cancellation signal during graceful shutdown, allowing event handlers to stop work cleanly.

| Property | Value |
|----------|-------|
| **Diagnostic ID** | NF0404 |
| **Severity** | Error |
| **Category** | RemoteFactory.Usage |
| **Default** | Enabled |

## Example

The following code triggers NF0404:

```csharp
[Factory]
public partial class OrderHandler
{
    // Error NF0404: Missing CancellationToken parameter
    [Event]
    public Task SendConfirmation(
        Guid orderId,
        [Service] IEmailService emailService)
    {
        return emailService.SendAsync(orderId, default);
    }
}
```

Also incorrect - CancellationToken must be the final parameter:

```csharp
[Factory]
public partial class OrderHandler
{
    // Error NF0404: CancellationToken is not the final parameter
    [Event]
    public Task SendConfirmation(
        Guid orderId,
        CancellationToken ct,  // Should be last
        [Service] IEmailService emailService)
    {
        return emailService.SendAsync(orderId, ct);
    }
}
```

## How to Fix

Add `CancellationToken` as the final parameter:

```csharp
[Factory]
public partial class OrderHandler
{
    // Correct: CancellationToken is the final parameter
    [Event]
    public Task SendConfirmation(
        Guid orderId,
        [Service] IEmailService emailService,
        CancellationToken ct)
    {
        return emailService.SendAsync(orderId, ct);
    }
}
```

## Why This Matters

Events run in background tasks and may be in progress when the server shuts down. The framework:

1. Tracks all pending event tasks via `IEventTracker`
2. On shutdown, signals cancellation via `IHostApplicationLifetime.ApplicationStopping`
3. Waits for pending events to complete (or cancel)

Without a CancellationToken parameter, event handlers cannot respond to shutdown signals:

```csharp
[Event]
public async Task ProcessLargeDataset(
    Guid datasetId,
    [Service] IDataService dataService,
    CancellationToken ct)
{
    var items = await dataService.GetItemsAsync(datasetId, ct);

    foreach (var item in items)
    {
        // Check cancellation to respond to shutdown
        ct.ThrowIfCancellationRequested();

        await ProcessItemAsync(item, ct);
    }
}
```

## Best Practices

1. **Pass the token to async operations**:
   ```csharp
   await service.DoSomethingAsync(ct);
   ```

2. **Check in loops**:
   ```csharp
   foreach (var item in items)
   {
       ct.ThrowIfCancellationRequested();
       // ...
   }
   ```

3. **Use it with EF Core**:
   ```csharp
   await db.SaveChangesAsync(ct);
   ```

## Related Diagnostics

- [NF0401](NF0401.md) - Event method must return void or Task
- [NF0403](NF0403.md) - Event method has no data parameters
