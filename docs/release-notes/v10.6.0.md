---
layout: default
title: "v10.6.0"
description: "Release notes for Neatoo RemoteFactory v10.6.0"
parent: Release Notes
nav_order: 2
---

# v10.6.0 - Fire-and-Forget Domain Events

**Release Date:** 2026-01-07
**NuGet:** [Neatoo.RemoteFactory 10.6.0](https://nuget.org/packages/Neatoo.RemoteFactory/10.6.0)

## Overview

This release introduces the `[Event]` attribute for fire-and-forget domain event handling with DI scope isolation and graceful shutdown support.

## What's New

### [Event] Attribute

Mark methods as fire-and-forget event handlers that run in isolated DI scopes:

```csharp
[Factory]
public partial class OrderModel
{
    [Event]
    public Task SendOrderConfirmation(
        Guid orderId,
        [Service] IEmailService emailService,
        CancellationToken ct)
    {
        return emailService.SendOrderConfirmationAsync(orderId, ct);
    }
}
```

**Generated delegate:**

```csharp
public partial class OrderModel
{
    public delegate Task SendOrderConfirmationEvent(Guid orderId);
}
```

**Key characteristics:**

| Aspect | Behavior |
|--------|----------|
| Return type | Always `Task` (even for `void` methods) |
| Scope | Runs in isolated DI scope |
| Exceptions | Logged but not thrown to caller |
| CancellationToken | Receives `ApplicationStopping` token |
| Graceful shutdown | Tracked by `IEventTracker` |

### Static Class Events

Events also work with static factory classes:

```csharp
[Factory]
public static partial class NotificationHandler
{
    [Event]
    public static Task NotifyWarehouse(
        Guid orderId,
        [Service] IAuditService auditService,
        CancellationToken ct)
    {
        return auditService.LogEventAsync("WarehouseNotified", orderId, ct);
    }
}
```

### IEventTracker for Graceful Shutdown

Track pending events and wait for completion during shutdown:

```csharp
public interface IEventTracker
{
    void Track(Task eventTask);
    int PendingCount { get; }
    Task WaitAllAsync(CancellationToken cancellationToken = default);
}
```

The `EventTrackerHostedService` automatically waits for pending events during ASP.NET Core shutdown.

### New Diagnostics

| ID | Severity | Description |
|----|----------|-------------|
| [NF0401](../diagnostics/NF0401.md) | Error | Event method must return void or Task |
| [NF0402](../diagnostics/NF0402.md) | Error | Event method must be in Factory class |
| [NF0403](../diagnostics/NF0403.md) | Warning | Event method has no data parameters |
| [NF0404](../diagnostics/NF0404.md) | Error | Event method must have CancellationToken as final parameter |

### New Log Events (9xxx)

| Event ID | Level | Description |
|----------|-------|-------------|
| 9001 | Information | Waiting for pending events |
| 9002 | Warning | Wait cancelled with events pending |
| 9003 | Warning | Event tasks failed during shutdown |
| 9004 | Error | Event handler failed |
| 9005-9009 | Various | Shutdown lifecycle events |

## Breaking Changes

None. This release is fully backward-compatible.

## Bug Fixes

### Fixed: HandleRemoteDelegateRequest crash for void-returning methods

**Problem:** Methods returning `Task` (non-generic) caused `InvalidOperationException: This operation is only valid on generic types` when the server tried to serialize the response.

**Solution:** Added `IsGenericType` check before calling `GetGenericTypeDefinition()`, and properly handle `VoidTaskResult` for void-returning async methods.

## Migration Guide

No migration required. To use the new events feature:

1. Add `[Event]` attribute to your event handler methods
2. Ensure the method returns `void` or `Task` (not `Task<T>`)
3. Add `CancellationToken` as the final parameter
4. Inject the generated delegate and invoke it

```csharp
// In your domain logic
public class OrderService
{
    private readonly OrderModel.SendOrderConfirmationEvent _sendConfirmation;

    public OrderService(OrderModel.SendOrderConfirmationEvent sendConfirmation)
    {
        _sendConfirmation = sendConfirmation;
    }

    public async Task ProcessOrder(Guid orderId)
    {
        // ... process order ...

        // Fire-and-forget - returns immediately
        _ = _sendConfirmation(orderId);
    }
}
```

## Commits

- `9b33a87` feat: add [Event] attribute for fire-and-forget domain events
- `69af073` docs: migrate documentation to use compiled code snippets
